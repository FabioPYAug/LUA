const { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const { Ids, TIRARNEGATIVO } = require('../includes/functions.js');
const fs = require('fs');
const path = require('path');
const imagenspath = path.join(__dirname, '..', 'comunidade', 'imagens.json');
const frasespath = path.join(__dirname, '..', 'comunidade', 'dinheiro.json');

function readDataFromFile() {
    if (fs.existsSync(frasespath)) {
        const JSONDADOS = fs.readFileSync(frasespath, 'utf8');
        return JSON.parse(JSONDADOS);
    }
    return { DINHEIRO: {} };
}

async function writeDataToFile(data) {
    const jsonString = JSON.stringify(data, null, 2);
    fs.writeFileSync(frasespath, jsonString, 'utf8');
}

const data = readDataFromFile();

async function Compra(carteira, valor, nomePagador) {
    if (carteira < valor) {
        return false;
    }
    carteira -= valor;
    data.DINHEIRO[nomePagador] = carteira;
    await writeDataToFile(data);
    return true;
}

async function atualizarInteracao(i, conteudo, componentes = [], embeds = []) {
    try {
        await i.update({
            content: conteudo,
            embeds: embeds,
            components: componentes,
        });
    } catch (error) {
        console.error("Erro ao atualizar intera√ß√£o:", error);
    }
}


module.exports = {
    data: new SlashCommandBuilder()
        .setName('loja')
        .setDescription('Acesse a loja para comprar itens'),
    async execute(interaction) {
        const idToNameMap = Object.fromEntries(
            Object.entries(Ids.usuarios).map(([name, id]) => [id, name])
        );

        const user = interaction.member;
        const userId = user.id;

        const nomePagador = idToNameMap[userId];

        if (!nomePagador) {
            return interaction.reply({ content: 'Usu√°rio n√£o encontrado na lista de registros.', ephemeral: true });
        }

        const carteiraDinheiro = data.DINHEIRO[nomePagador];

        const itens = [
            { nome: 'ANIMAL ALEAT√ìRIO', preco: 5, descricao: 'Ir√° enviar uma imagem de um Animal Aleat√≥rio' },
            { nome: 'MEME ALEAT√ìRIO', preco: 5, descricao: 'Ir√° enviar uma imagem de um Meme Aleat√≥rio' },
            { nome: 'DOCUMENTO ALEAT√ìRIO', preco: 5, descricao: 'Ir√° enviar uma imagem de um Documento Aleat√≥rio' },
            { nome: '√ÅGIL', preco: 2500, descricao: 'Ir√° dar o efeito √Ågil' },
            { nome: 'ENTRELA√áADOS', preco: 5000, descricao: 'Ir√° dar o efeito Entrela√ßados' },
            { nome: 'SORTE PEQUENA', preco: 5000, descricao: 'Ir√° dar Sorte Pequena' },
            { nome: 'SORTE M√âDIA', preco: 10000, descricao: 'Ir√° dar Sorte M√©dia' },
            { nome: 'PROTEGIDO', preco: 15000, descricao: 'Ir√° dar o efeito Protegido' },
            { nome: 'SORTE GRANDE', preco: 17777, descricao: 'Ir√° dar Sorte Grande' },
            { nome: 'HIGIENIZAR IMPUREZAS', preco: 30000, descricao: 'Ir√° limpar os status negativos' },
        ];

        const itensPorPagina = 3;
        let paginaAtual = 0;

        function gerarEmbed(pagina) {
            const startIndex = pagina * itensPorPagina;
            const itensPagina = itens.slice(startIndex, startIndex + itensPorPagina);

            const embed = new EmbedBuilder()
                .setTitle('ùôªùôæùôπùô∞ ùô¥ùô≤ùô≤ùôªùô¥ùöÇùô∏ùô∞')
                .setDescription('Ecclesia √© a MAIOR loja de Zoystea! Tendo tudo que um aventureiro, fazendeiro ou at√© morador quer!\n\nEscolha qual desses itens voc√™ deseja!')
                .setColor('Green');

            itensPagina.forEach(item => {
                embed.addFields(
                    { name: item.nome, value: `${item.descricao}\nPre√ßo: ${item.preco} ZENS`, inline: false }
                );
            });

            return embed;
        }

        function gerarBotoes(pagina) {
            const row = new ActionRowBuilder();
            itens.slice(pagina * itensPorPagina, pagina * itensPorPagina + itensPorPagina).forEach((item, index) => {
                row.addComponents(
                    new ButtonBuilder()
                        .setCustomId(`comprar_${pagina * itensPorPagina + index}`)
                        .setLabel(`${item.nome}`)
                        .setStyle(ButtonStyle.Primary)
                );
            });
            if (pagina > 0) {
                row.addComponents(
                    new ButtonBuilder()
                        .setCustomId('pagina_anterior')
                        .setLabel('P√°gina Anterior')
                        .setStyle(ButtonStyle.Secondary)
                );
            }

            if ((pagina + 1) * itensPorPagina < itens.length) {
                row.addComponents(
                    new ButtonBuilder()
                        .setCustomId('proxima_pagina')
                        .setLabel('Pr√≥xima P√°gina')
                        .setStyle(ButtonStyle.Secondary)
                );
            }

            return row;
        }

        const embed = gerarEmbed(paginaAtual);
        const botoes = gerarBotoes(paginaAtual);

        await interaction.reply({
            embeds: [embed],
            components: [botoes],
            ephemeral: true
        });

        const filter = i => i.user.id === interaction.user.id;
        const collector = interaction.channel.createMessageComponentCollector({ filter, time: 180000 });

        collector.on('collect', async (i) => {
            try {
                if (i.customId.startsWith('comprar_')) {
                    const index = parseInt(i.customId.split('_')[1]);
                    const itemComprado = itens[index];

                    if (itemComprado.nome === "ANIMAL ALEAT√ìRIO") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            const imagensData = JSON.parse(fs.readFileSync(imagenspath, 'utf-8'));
                            const randomAnimal = imagensData.imagens.animais[
                                Math.floor(Math.random() * imagensData.imagens.animais.length)
                            ];
                            await interaction.channel.send({ content: randomAnimal });
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                    if (itemComprado.nome === "MEME ALEAT√ìRIO") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            const imagensData = JSON.parse(fs.readFileSync(imagenspath, 'utf-8'));
                            const randomAnimal = imagensData.imagens.memes[
                                Math.floor(Math.random() * imagensData.imagens.memes.length)
                            ];
                            await interaction.channel.send({ content: randomAnimal });
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                    if (itemComprado.nome === "DOCUMENTO ALEAT√ìRIO") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            const imagensData = JSON.parse(fs.readFileSync(imagenspath, 'utf-8'));
                            const randomAnimal = imagensData.imagens.documentos[
                                Math.floor(Math.random() * imagensData.imagens.documentos.length)
                            ];
                            await interaction.channel.send({ content: randomAnimal });
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                    if (itemComprado.nome === "ENTRELA√áADOS") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            if(user.roles.cache.has(Ids.positivos.Entrelacados)){
                                await interaction.channel.send({content: "Voc√™ j√° tem esse produto!", ephemeral: true})
                                return;
                            }
                            interaction.member.roles.add(Ids.positivos.Entrelacados)
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                    if (itemComprado.nome === "√ÅGIL") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            if(user.roles.cache.has(Ids.positivos.rapido)){
                                await interaction.channel.send({content: "Voc√™ j√° tem esse produto!", ephemeral: true})
                                return;
                            }
                            interaction.member.roles.add(Ids.positivos.rapido)
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                    if (itemComprado.nome === "PROTEGIDO") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            if(user.roles.cache.has(Ids.positivos.Protegido)){
                                await interaction.channel.send({content: "Voc√™ j√° tem esse produto!", ephemeral: true})
                                return;
                            }
                            interaction.member.roles.add(Ids.positivos.Protegido)
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                    if (itemComprado.nome === "HIGIENIZAR IMPUREZAS") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            TIRARNEGATIVO(user)
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                    if (itemComprado.nome === "SORTE PEQUENA") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            if(user.roles.cache.has(Ids.unicos.Venturado)){
                                await interaction.channel.send({content: "Voc√™ j√° tem esse produto!", ephemeral: true})
                                return;
                            }
                            interaction.member.roles.add(Ids.unicos.Venturado)
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                    if (itemComprado.nome === "SORTE M√âDIA") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            if(user.roles.cache.has(Ids.unicos.Afortunado)){
                                await interaction.channel.send({content: "Voc√™ j√° tem esse produto!", ephemeral: true})
                                return;
                            }
                            interaction.member.roles.add(Ids.unicos.Afortunado)
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                    if (itemComprado.nome === "SORTE GRANDE") {
                        const compraBemSucedida = await Compra(carteiraDinheiro, itemComprado.preco, nomePagador);
                        if (compraBemSucedida) {
                            if(user.roles.cache.has(Ids.unicos.Contingente)){
                                await interaction.channel.send({content: "Voc√™ j√° tem esse produto!", ephemeral: true})
                                return;
                            }
                            interaction.member.roles.add(Ids.unicos.Contingente)
                            await atualizarInteracao(i, `Voc√™ comprou: ${itemComprado.nome}! Obrigado pela sua compra!`);
                        } else {
                            await atualizarInteracao(i, "Voc√™ n√£o tem dinheiro suficiente para comprar este item!");
                        }
                        return;
                    }
                                     
                }

                if (i.customId === 'pagina_anterior') {
                    paginaAtual--;
                } else if (i.customId === 'proxima_pagina') {
                    paginaAtual++;
                }

                const novoEmbed = gerarEmbed(paginaAtual);
                const novosBotoes = gerarBotoes(paginaAtual);

                await i.update({
                    embeds: [novoEmbed],
                    components: [novosBotoes],
                });
            } catch (error) {
                console.error("Erro na coleta de intera√ß√£o:", error);
            }
        });

        collector.on('end', async () => {
            await interaction.editReply({
                components: [],
            });
        });
    },
};
